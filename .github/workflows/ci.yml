name: CI

on:
  pull_request_target:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Check required lock files exist
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "::error::package-lock.json is missing"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com
          scope: "@tetherto"
          cache: npm

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Validate semantic versioning
        id: semver
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [[ "$VERSION" =~ '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$' ]]; then
            echo "::error::Version $VERSION does not follow semantic versioning"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Check version not already published (if publish label present)
        if: contains(github.event.pull_request.labels.*.name, 'publish')
        run: |
          VERSION="${{ steps.semver.outputs.VERSION }}"
          PACKAGE_NAME=$(node -p "require('./package.json').name")

          # Check if version exists in public npm registry
          if npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null; then
            echo "::error::Version $VERSION of $PACKAGE_NAME has already been published to npm"
            exit 1
          else
            echo "Version $VERSION is available for publishing"
          fi

      - name: Install dependencies
        run: npm ci --install-links
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NOXTTON_BOT_PAT }}

      - name: Generate worklet bundle for Autofill
        run: npm run bundle:autofill

      - name: Install EAS CLI
        run: npm install --global eas-cli

      - name: Write Google Play service account key
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY_JSON }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_KEY_JSON" > $GITHUB_WORKSPACE/google-service-account.json

      - name: Resolve EAS profile by branch
        id: branch_profile
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            PROFILE=production
          else
            PROFILE=preview
          fi
          echo "PROFILE=$PROFILE" >> "$GITHUB_OUTPUT"

      - name: Add -dev suffix to expo.version for dev branch (Android)
        if: github.ref == 'refs/heads/dev'
        run: |
          BASE_VERSION="${{ steps.semver.outputs.VERSION }}"
          DEV_VERSION="${BASE_VERSION%-dev}-dev"
          tmp=$(mktemp)
          jq --arg v "$DEV_VERSION" '.expo.version = $v' app.json > "$tmp"
          mv "$tmp" app.json
          echo "expo.version updated to: $DEV_VERSION (Android dev build)"

      - name: EAS build (Android local) with auto submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_GOOGLE_SERVICE_ACCOUNT_KEY_PATH: "${{ env.GITHUB_WORKSPACE }}/google-service-account.json"
          CREDENTIALS_JSON: ${{ secrets.CREDENTIALS_JSON }}
          GOOGLE_PLAY_KEYSTORE: ${{ secrets.GOOGLE_PLAY_KEYSTORE }}
          SLACK_WEBHOOK_URL_PATH: ${{ secrets.SLACK_WEBHOOK_URL_PATH }}
          GOOGLE_FORM_KEY: ${{ secrets.GOOGLE_FORM_KEY }}
          GOOGLE_FORM_MAPPING_TIMESTAMP: ${{ secrets.GOOGLE_FORM_MAPPING_TIMESTAMP }}
          GOOGLE_FORM_MAPPING_TOPIC: ${{ secrets.GOOGLE_FORM_MAPPING_TOPIC }}
          GOOGLE_FORM_MAPPING_APP: ${{ secrets.GOOGLE_FORM_MAPPING_APP }}
          GOOGLE_FORM_MAPPING_OPERATING_SYSTEM: ${{ secrets.GOOGLE_FORM_MAPPING_OPERATING_SYSTEM }}
          GOOGLE_FORM_MAPPING_DEVICE_MODEL: ${{ secrets.GOOGLE_FORM_MAPPING_DEVICE_MODEL }}
          GOOGLE_FORM_MAPPING_MESSAGE: ${{ secrets.GOOGLE_FORM_MAPPING_MESSAGE }}
          GOOGLE_FORM_MAPPING_APP_VERSION: ${{ secrets.GOOGLE_FORM_MAPPING_APP_VERSION }}
          TEST_SLACK_WEBHOOK_URL_PATH: ${{ secrets.TEST_SLACK_WEBHOOK_URL_PATH }}
          TEST_GOOGLE_FORM_KEY: ${{ secrets.TEST_GOOGLE_FORM_KEY }}
          TEST_GOOGLE_FORM_MAPPING_TIMESTAMP: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_TIMESTAMP }}
          TEST_GOOGLE_FORM_MAPPING_TOPIC: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_TOPIC }}
          TEST_GOOGLE_FORM_MAPPING_APP: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_APP }}
          TEST_GOOGLE_FORM_MAPPING_OPERATING_SYSTEM: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_OPERATING_SYSTEM }}
          TEST_GOOGLE_FORM_MAPPING_DEVICE_MODEL: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_DEVICE_MODEL }}
          TEST_GOOGLE_FORM_MAPPING_MESSAGE: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_MESSAGE }}
          TEST_GOOGLE_FORM_MAPPING_APP_VERSION: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_APP_VERSION }}
          IOS_APP_GROUP_ID: ${{ secrets.IOS_APP_GROUP_ID }}
        run: |
          mkdir -p android/keystores
          echo $GOOGLE_PLAY_KEYSTORE | base64 -d > android/keystores/release.keystore
          echo $CREDENTIALS_JSON | base64 -d > credentials.json
          # CHANGED: add branch-aware profile
          eas build --platform android --profile ${{ steps.branch_profile.outputs.PROFILE }} --local --non-interactive

  ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          token: ${{ secrets.PAT_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: "https://npm.pkg.github.com"
          scope: "@tetherto"

      - name: Install Apple WWDRC Authority
        run: |
          curl -O https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer
          sudo security add-trusted-cert -d -r unspecified -k ~/Library/Keychains/login.keychain-db AppleWWDRCAG3.cer

      - name: Install dependencies
        run: npm ci --install-links
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NOXTTON_BOT_PAT }}

      - name: Generate worklet bundle for iOS
        run: npm run bundle:ios

      - name: Generate worklet bundle for Autofill
        run: npm run bundle:autofill

      - name: Extract translations
        run: |
          npm run lingui:extract
          npm run lingui:compile

      - name: Install EAS CLI
        run: npm install --global eas-cli

      - name: Resolve EAS profile by branch
        id: branch_profile
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            PROFILE=production
          else
            PROFILE=preview
          fi
          echo "PROFILE=$PROFILE" >> "$GITHUB_OUTPUT"

      - name: EAS build (iOS local) with auto submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          CREDENTIALS_JSON: ${{ secrets.CREDENTIALS_JSON }}
          APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
          APPLE_PROVISIONING_PROFILE_AUTOFILL: ${{ secrets.APPLE_PROVISIONING_PROFILE_AUTOFILL }}
          APPLE_DISTRIBUTION_CERTIFICATE: ${{ secrets.APPLE_DISTRIBUTION_CERTIFICATE }}
          SLACK_WEBHOOK_URL_PATH: ${{ secrets.SLACK_WEBHOOK_URL_PATH }}
          GOOGLE_FORM_KEY: ${{ secrets.GOOGLE_FORM_KEY }}
          GOOGLE_FORM_MAPPING_TIMESTAMP: ${{ secrets.GOOGLE_FORM_MAPPING_TIMESTAMP }}
          GOOGLE_FORM_MAPPING_TOPIC: ${{ secrets.GOOGLE_FORM_MAPPING_TOPIC }}
          GOOGLE_FORM_MAPPING_APP: ${{ secrets.GOOGLE_FORM_MAPPING_APP }}
          GOOGLE_FORM_MAPPING_OPERATING_SYSTEM: ${{ secrets.GOOGLE_FORM_MAPPING_OPERATING_SYSTEM }}
          GOOGLE_FORM_MAPPING_DEVICE_MODEL: ${{ secrets.GOOGLE_FORM_MAPPING_DEVICE_MODEL }}
          GOOGLE_FORM_MAPPING_MESSAGE: ${{ secrets.GOOGLE_FORM_MAPPING_MESSAGE }}
          GOOGLE_FORM_MAPPING_APP_VERSION: ${{ secrets.GOOGLE_FORM_MAPPING_APP_VERSION }}
          TEST_SLACK_WEBHOOK_URL_PATH: ${{ secrets.TEST_SLACK_WEBHOOK_URL_PATH }}
          TEST_GOOGLE_FORM_KEY: ${{ secrets.TEST_GOOGLE_FORM_KEY }}
          TEST_GOOGLE_FORM_MAPPING_TIMESTAMP: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_TIMESTAMP }}
          TEST_GOOGLE_FORM_MAPPING_TOPIC: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_TOPIC }}
          TEST_GOOGLE_FORM_MAPPING_APP: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_APP }}
          TEST_GOOGLE_FORM_MAPPING_OPERATING_SYSTEM: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_OPERATING_SYSTEM }}
          TEST_GOOGLE_FORM_MAPPING_DEVICE_MODEL: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_DEVICE_MODEL }}
          TEST_GOOGLE_FORM_MAPPING_MESSAGE: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_MESSAGE }}
          TEST_GOOGLE_FORM_MAPPING_APP_VERSION: ${{ secrets.TEST_GOOGLE_FORM_MAPPING_APP_VERSION }}
          IOS_APP_GROUP_ID: ${{ secrets.IOS_APP_GROUP_ID }}
        run: |
          mkdir -p ios/certs
          echo $APPLE_PROVISIONING_PROFILE | base64 -d > ios/certs/profile.mobileprovision
          echo $APPLE_PROVISIONING_PROFILE_AUTOFILL | base64 -d > ios/certs/profile-autofill.mobileprovision
          echo $APPLE_DISTRIBUTION_CERTIFICATE | base64 -d > ios/certs/dist-cert.p12
          echo $CREDENTIALS_JSON | base64 -d > credentials.json
          # CHANGED: add branch-aware profile
          eas build --platform ios --profile ${{ steps.branch_profile.outputs.PROFILE }} --local --non-interactive
